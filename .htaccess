# Enable URL rewriting
RewriteEngine On

# If your site is in a subfolder (e.g., /store/), set RewriteBase accordingly.
# For root domain, you may omit RewriteBase or set to '/'.
#RewriteBase /

# Skip rewriting for existing files or directories
RewriteCond %{REQUEST_FILENAME} -f [OR]
RewriteCond %{REQUEST_FILENAME} -d
RewriteRule ^ - [L]

## Pretty product URL: /p/123-some-slug -> product.php?id=123
RewriteRule ^p/([0-9]+)-([A-Za-z0-9-]+)/?$ product.php?id=$1 [L,QSA]

## Optional: redirect legacy URL to pretty URL (prevents duplicate content)
# This relies on PHP to generate the canonical slug
RewriteCond %{THE_REQUEST} \s/product\.php\?id=([0-9]+)\s [NC]
RewriteRule ^ product.php?id=%1&redirect=1 [L,QSA]

## Pretty pages
# / -> index.php
RewriteRule ^$ index.php [L]
# /services -> services.php
RewriteRule ^services/?$ services.php [L,QSA]
# /cart -> cart.php
RewriteRule ^cart/?$ cart.php [L,QSA]

# SEO endpoints
RewriteRule ^sitemap\.xml$ sitemap.php [L,QSA]
RewriteRule ^robots\.txt$ robots.php [L,QSA]

## Redirect legacy .php to pretty paths (optional)
RewriteCond %{THE_REQUEST} \s/index\.php\s [NC]
RewriteRule ^index\.php$ / [R=301,L]

RewriteCond %{THE_REQUEST} \s/services\.php\s [NC]
RewriteRule ^services\.php$ services [R=301,L]

RewriteCond %{THE_REQUEST} \s/cart\.php\s [NC]
RewriteRule ^cart\.php$ cart [R=301,L]

# Custom 404 page
ErrorDocument 404 /store/404.php

# ----------------------------------------------------------------------
# Compression (Brotli / Gzip)
# ----------------------------------------------------------------------
<IfModule mod_brotli.c>
  BrotliCompressionQuality 5
  AddOutputFilterByType BROTLI_COMPRESS text/plain text/html text/xml text/css text/javascript application/javascript application/x-javascript application/json application/xml image/svg+xml
</IfModule>
<IfModule mod_deflate.c>
  AddOutputFilterByType DEFLATE text/plain text/html text/xml text/css text/javascript application/javascript application/x-javascript application/json application/xml image/svg+xml
</IfModule>

# ----------------------------------------------------------------------
# Caching headers for static assets
# ----------------------------------------------------------------------
<IfModule mod_expires.c>
  ExpiresActive On
  # Images
  ExpiresByType image/avif "access plus 6 months"
  ExpiresByType image/avifs "access plus 6 months"
  ExpiresByType image/webp "access plus 6 months"
  ExpiresByType image/png  "access plus 6 months"
  ExpiresByType image/jpeg "access plus 6 months"
  ExpiresByType image/gif  "access plus 6 months"
  ExpiresByType image/svg+xml "access plus 6 months"
  # Fonts
  ExpiresByType font/woff2 "access plus 12 months"
  ExpiresByType font/woff  "access plus 12 months"
  ExpiresByType application/font-woff2 "access plus 12 months"
  # CSS & JS
  ExpiresByType text/css "access plus 3 months"
  ExpiresByType application/javascript "access plus 3 months"
  ExpiresByType text/javascript "access plus 3 months"
</IfModule>

# Additional Cache-Control for static files
<FilesMatch "\.(?:avif|webp|png|jpe?g|gif|svg|ico)$">
  <IfModule mod_headers.c>
    Header set Cache-Control "public, max-age=15552000, immutable"
  </IfModule>
</FilesMatch>
<FilesMatch "\.(?:css|js)$">
  <IfModule mod_headers.c>
    Header set Cache-Control "public, max-age=7776000"
  </IfModule>
</FilesMatch>
